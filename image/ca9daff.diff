From ca9daff64e7cc9bb7616980559a0335aab8f5209 Mon Sep 17 00:00:00 2001
From: Morten Johan SÃ¸rvig <morten.sorvig@qt.io>
Date: Fri, 10 May 2019 12:04:52 +0200
Subject: [PATCH] wasm: recreate backing store texture with valid gl context

The compositor context is not current during the resize()
call, but will be during updateTexture().

Change-Id: I29c2e06aa251b564b5d622dc9380ec994e15aab0
Reviewed-by: Lorn Potter <lorn.potter@gmail.com>
 
 
 
 
 
 
 
 
 
 
 
 
 
 
---

diff --git a/src/plugins/platforms/wasm/qwasmbackingstore.cpp b/src/plugins/platforms/wasm/qwasmbackingstore.cpp
index e8eda26..7e8a382 100644
--- a/src/plugins/platforms/wasm/qwasmbackingstore.cpp
+++ b/src/plugins/platforms/wasm/qwasmbackingstore.cpp
@@ -81,6 +81,11 @@
     if (m_dirty.isNull())
         return;
 
+    if (m_recreateTexture && m_texture->isCreated()) {
+        m_recreateTexture = false;
+        m_texture->destroy();
+    }
+
     if (!m_texture->isCreated()) {
         m_texture->setMinificationFilter(QOpenGLTexture::Nearest);
         m_texture->setMagnificationFilter(QOpenGLTexture::Nearest);
@@ -146,9 +151,7 @@
 
     m_image = QImage(size * window()->devicePixelRatio(), QImage::Format_RGB32);
     m_image.setDevicePixelRatio(window()->devicePixelRatio());
-
-    if (m_texture->isCreated())
-        m_texture->destroy();
+    m_recreateTexture = true;
 }
 
 QImage QWasmBackingStore::toImage() const
diff --git a/src/plugins/platforms/wasm/qwasmbackingstore.h b/src/plugins/platforms/wasm/qwasmbackingstore.h
index 4bca83c..b93c96b 100644
--- a/src/plugins/platforms/wasm/qwasmbackingstore.h
+++ b/src/plugins/platforms/wasm/qwasmbackingstore.h
@@ -64,6 +64,7 @@
     QImage m_image;
     QScopedPointer<QOpenGLTexture> m_texture;
     QRegion m_dirty;
+    bool m_recreateTexture = false;
 };
 
 QT_END_NAMESPACE
